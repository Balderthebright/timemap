#summary Quick tutorial on how to use filter chains in timemap.js

= Introduction =

Timemap.js uses the concept of filter chains for hiding and showing items, but they can be applied for a variety of other uses as well. Basically, if you want to do something (hide, change color, cause to do a dance) to all items, or a subset of items, based on some event, then you want to use a filter chain.

The filter chain architecture has three basic parts:

  # *The chain itself.* Each chain has a name, an array of filters, an "on" function, and an "off" function. The "on" function is applied if an item passes the filters (see below), and the "off" function is applied if it doesn't. The basic example here is a hide/show filter chain: In this case, the "on" function shows an item, and the "off" function hides it. Every timemap (as of v.1.5) starts off with two filter chains: "map", which shows and hides items on the map, and "timeline", which shows and hides events on the timeline.<br><br>
  # *Filters.* Each filter chain includes an array of one or more filters. Each filter is a function taking one parameter, a `TimeMapItem`, and returning either `true` or `false` based on the current state of the item. For example, the `TimeMap.hidePastFuture` filter looks at a single item and returns `true` or `false` depending on whether the item's event is currently visible in the timeline.<br><br>
  # *A listener or other calling mechanism.* Now that you have a filter chain, you need to determine when the filter runs. For example, timemap.js calls the "map" filter every time the user scrolls the timeline. You could run the filter when the user zoomed the map in or out, moved the center of the map, pressed a button, etc. 
  
= Example =

*Show items based on a custom property*

[http://code.google.com/p/timemap/source/browse/trunk/examples/filter.html See the completed example here.]

Say you have a dataset with a bunch of items, and each item has a set of tags. Above your timemap, you put a dropdown menu with a list of tags, defaulting to "All tags". When the user selects a tag from the dropdown menu, you want to display only items with that tag on your timemap.

  # First, you need to load your items so that they include the tag data. There are various different ways to do this, but for the sake of simplicity let's assume that you're loading data in JSON. Anything you include in the `options` property of the item object you load will be available in the `opts` property of the `TimeMapItem` that is created when your data is loaded. So if a single item, in your JSON data, looks like this, you'll be able to access your tag array as `item.opts.tags`:
{{{
{
    title: "My item",
    start: "2009-01-01",
    point: {
        lat: 36,
        lon: -123
    },
    options: {
        tags: ['spam', 'spork', 'spackle']
    }
}
}}}
  # You _don't_ need a new filter chain - you can use the "map" and "timeline" chains built into timemap.js. If you wanted to do something other than hide and show the items - for example, change their color - you'd need to add a new filter chain using the `tm.addFilterChain()` function.<br><br>
  # You need a way to know what the dropdown menu is set to. Again, there are many ways to do this, but let's make it simple: When the user changes the dropdown, you'll set a global variable - let's attach it to the window and call it `window.selectedTag`.<br><br>
  # You need to add a new filter, to check the tags against the dropdown menu. It should look at an item and determine whether the `selectedTag` is in the array. You don't need to put this function in `TimeMap.filters`, but it keeps your namespaces nice and tidy:
{{{
TimeMap.filters.hasSelectedTag = function(item) {
    // if no tag was selected, every item should pass the filter
    if (!window.selectedTag) {
        return true;
    }
    if (item.opts.tags) {
        // look for selected tag
        if (item.opts.tags.indexOf(window.selectedTag) >= 0) {
            // tag found, item passes
            return true;
        } 
        else {
            // indexOf() returned -1, so the tag wasn't found
            return false;
        }
    }
    else {
        // item didn't have any tags
        return false;
    }
};
}}}
  # You'll need to add this filter to the existing filter chains for the map and timeline (most likely in your onLoad function, after you've called `TimeMap.init()`):
{{{
// add our new function to the map and timeline filter chains
tm.addFilter("map", TimeMap.filters.hasSelectedTag); // hide map markers on fail
tm.addFilter("timeline", TimeMap.filters.hasSelectedTag); // hide timeline events on fail
}}}
  # Now you just need to add a handler that can fire when the dropdown menu changes. The handler will need to explicitly make the filters run:
{{{
// onChange handler for dropdown menu
function setSelectedTag(select) {
    var idx = select.selectedIndex;
    window.selectedTag = select.options[idx].value;
    // run filters
    tm.filter('map');
    tm.filter('timeline');
    // you'll need this to make the timeline update
    tm.timeline.layout();
}
}}}
  # Add the handler to your dropdown menu and you're done!

Note that if you want the layout of your items to get reset when some of them are hidden, you'll need to use a later version of Timeline, e.g. http://static.simile.mit.edu/timeline/api-2.2.0/timeline-api.js .